// generated by Diff/AST Java Unparser
package org.cometd.oort;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.atomic.AtomicLong;
import org.cometd.bayeux.server.BayeuxServer;
import org.cometd.bayeux.server.LocalSession;
import org.cometd.bayeux.server.ServerChannel;
import org.cometd.bayeux.server.ServerMessage;
import org.cometd.bayeux.server.ServerSession;
import org.eclipse.jetty.util.component.AbstractLifeCycle;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
public abstract class OortService<R, C>
    extends AbstractLifeCycle implements ServerChannel.MessageListener {
  private static final String ACTION_FIELD = "oort.service.action";
  private static final String ID_FIELD = "oort.service.id";
  private static final String OORT_URL_FIELD = "oort.service.url";
  private static final String RESULT_FIELD = "oort.service.result";
  private static final String FAILURE_FIELD = "oort.service.failure";
  private final AtomicLong actions = new AtomicLong();
  private final ConcurrentMap<Long, C> callbacks =
      new ConcurrentHashMap<Long, C>();
  private final Oort oort;
  private final String name;
  private final String forwardChannelName;
  private final String resultChannelName;
  private final LocalSession session;
  protected final Logger logger;
  protected OortService(Oort oort, String name) {
    this.oort = oort;
    this.name = name;
    this.forwardChannelName = "/service/oort/service/" + name;
    this.resultChannelName = forwardChannelName + "/result";
    this.session = oort.getBayeuxServer().newLocalSession(name);
    this.logger = LoggerFactory.getLogger(getLoggerName());
  }
  protected String getLoggerName() { return getClass().getName(); }
  public Oort getOort() { return oort; }
  public String getName() { return name; }
  public LocalSession getLocalSession() { return session; }
  @Override
  protected void doStart() throws Exception {
    session.handshake();
    BayeuxServer bayeuxServer = oort.getBayeuxServer();
    bayeuxServer.createIfAbsent(forwardChannelName);
    bayeuxServer.getChannel(forwardChannelName).addListener(this);
    bayeuxServer.createIfAbsent(resultChannelName);
    bayeuxServer.getChannel(resultChannelName).addListener(this);
    logger.debug("Started {}", this);
  }
  @Override
  protected void doStop() throws Exception {
    BayeuxServer bayeuxServer = oort.getBayeuxServer();
    bayeuxServer.getChannel(resultChannelName).removeListener(this);
    bayeuxServer.getChannel(forwardChannelName).removeListener(this);
    session.disconnect();
    logger.debug("Stopped {}", this);
  }
  protected boolean forward(String targetOortURL, Object actionData,
                            C context) {
    long actionId = actions.incrementAndGet();
    if (context != null)
      callbacks.put(actionId, context);
    Map<String, Object> data = new HashMap<String, Object>(3);
    data.put(ID_FIELD, actionId);
    data.put(ACTION_FIELD, actionData);
    String localOortURL = getOort().getURL();
    data.put(OORT_URL_FIELD, localOortURL);
    if (localOortURL.equals(targetOortURL)) {
      logger.debug("Forwarding action locally ({}): {}", localOortURL, data);
      oort.getBayeuxServer()
          .getChannel(forwardChannelName)
          .publish(getLocalSession(), data, null);
      return true;
    } else {
      if (targetOortURL != null) {
        OortComet comet = getOort().getComet(targetOortURL);
        if (comet != null) {
          logger.debug("Forwarding action from {} to {}: {}", localOortURL,
                       targetOortURL, data);
          comet.getChannel(forwardChannelName).publish(data);
          return true;
        }
      }
      logger.debug("Could not forward action from {} to {}: {}", localOortURL,
                   targetOortURL, data);
      return false;
    }
  }
  public boolean onMessage(ServerSession from, ServerChannel channel,
                           ServerMessage.Mutable message) {
    if (forwardChannelName.equals(message.getChannel())) {
      logger.debug("Received forwarded action {}", message);
      Map<String, Object> data = message.getDataAsMap();
      Map<String, Object> resultData = new HashMap<String, Object>(3);
      resultData.put(ID_FIELD, data.get(ID_FIELD));
      resultData.put(OORT_URL_FIELD, getOort().getURL());
      try {
        R result = onForward(data.get(ACTION_FIELD));
        resultData.put(RESULT_FIELD, result);
      } catch (ServiceException x) {
        resultData.put(FAILURE_FIELD, x.getFailure());
      } catch (Exception x) {
        String failure = x.getMessage();
        if (failure == null || failure.length() == 0)
          failure = x.getClass().getName();
        resultData.put(FAILURE_FIELD, failure);
      }
      String oortURL = (String)data.get(OORT_URL_FIELD);
      if (getOort().getURL().equals(oortURL)) {
        logger.debug("Returning forwarded action result {} to local {}",
                     resultData, oortURL);
        oort.getBayeuxServer()
            .getChannel(resultChannelName)
            .publish(getLocalSession(), resultData, null);
      } else {
        OortComet comet = getOort().getComet(oortURL);
        if (comet != null) {
          logger.debug("Returning forwarded action result {} to remote {}",
                       resultData, oortURL);
          comet.getChannel(resultChannelName).publish(resultData);
        } else {
          logger.debug(
              "Could not return forwarded action result {} to remote {}",
              resultData, oortURL);
        }
      }
    } else if (resultChannelName.equals(message.getChannel())) {
      logger.debug("Received forwarded action result {}", message);
      Map<String, Object> data = message.getDataAsMap();
      long actionId = ((Number)data.get(ID_FIELD)).longValue();
      C context = callbacks.remove(actionId);
      if (context != null) {
        Object failure = data.get(FAILURE_FIELD);
        if (failure != null) {
          onForwardFailed(failure, context);
        } else {
          @SuppressWarnings("unchecked") R result = (R)data.get(RESULT_FIELD);
          onForwardSucceeded(result, context);
        }
      }
    }
    return true;
  }
  protected abstract R onForward(Object actionData);
  protected abstract void onForwardSucceeded(R result, C context);
  protected abstract void onForwardFailed(Object failure, C context);
  @Override
  public String toString() {
    return String.format("%s[%s]@%s", getClass().getSimpleName(), getName(),
                         getOort().getURL());
  }
  public static class ServiceException extends RuntimeException {
    private final Object failure;
    public ServiceException(Object failure) { this.failure = failure; }
    public ServiceException(Throwable cause, Object failure) {
      super(cause);
      this.failure = failure;
    }
    public Object getFailure() { return failure; }
  }
  public static class ServerContext {
    private final ServerSession session;
    private final ServerMessage message;
    public ServerContext(ServerSession session, ServerMessage message) {
      this.session = session;
      this.message = message;
    }
    public ServerSession getServerSession() { return session; }
    public ServerMessage getServerMessage() { return message; }
  }
}