// generated by Diff/AST Java Unparser
package org.elasticsearch.env;
import org.elasticsearch.cluster.ClusterName;
import org.elasticsearch.common.SuppressForbidden;
import org.elasticsearch.common.io.PathUtils;
import org.elasticsearch.common.settings.Settings;
import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URISyntaxException;
import java.net.URL;
import java.nio.file.FileStore;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import static org.elasticsearch.common.Strings.cleanPath;
@SuppressForbidden(reason = "configures paths for the system")
public class Environment {
  private final Settings settings;
  private final Path[] dataFiles;
  private final Path[] dataWithClusterFiles;
  private final Path[] repoFiles;
  private final Path configFile;
  private final Path scriptsFile;
  private final Path pluginsFile;
  private final Path sharedDataFile;
  private final Path binFile;
  private final Path libFile;
  private final Path logsFile;
  private final Path pidFile;
  private final Path tmpFile =
      PathUtils.get(System.getProperty("java.io.tmpdir"));
  private static final FileStore[] fileStores;
  static {
    ArrayList<FileStore> allStores = new ArrayList<>();
    for (FileStore store : PathUtils.getDefaultFileSystem().getFileStores()) {
      allStores.add(new ESFileStore(store));
    }
    fileStores = allStores.toArray(new ESFileStore[allStores.size()]);
  }
  public Environment(Settings settings) {
    this.settings = settings;
    final Path homeFile;
    if (settings.get("path.home") != null) {
      homeFile = PathUtils.get(cleanPath(settings.get("path.home")));
    } else {
      throw new IllegalStateException("path.home is not configured");
    }
    if (settings.get("path.conf") != null) {
      configFile = PathUtils.get(cleanPath(settings.get("path.conf")));
    } else {
      configFile = homeFile.resolve("config");
    }
    if (settings.get("path.scripts") != null) {
      scriptsFile = PathUtils.get(cleanPath(settings.get("path.scripts")));
    } else {
      scriptsFile = configFile.resolve("scripts");
    }
    if (settings.get("path.plugins") != null) {
      pluginsFile = PathUtils.get(cleanPath(settings.get("path.plugins")));
    } else {
      pluginsFile = homeFile.resolve("plugins");
    }
    String[] dataPaths = settings.getAsArray("path.data");
    if (dataPaths.length > 0) {
      dataFiles = new Path[dataPaths.length];
      dataWithClusterFiles = new Path[dataPaths.length];
      for (int i = 0; i < dataPaths.length; i++) {
        dataFiles[i] = PathUtils.get(dataPaths[i]);
        dataWithClusterFiles[i] = dataFiles[i].resolve(
            ClusterName.clusterNameFromSettings(settings).value());
      }
    } else {
      dataFiles = new Path[] {homeFile.resolve("data")};
      dataWithClusterFiles = new Path[] {homeFile.resolve("data").resolve(
          ClusterName.clusterNameFromSettings(settings).value())};
    }
    if (settings.get("path.shared_data") != null) {
      sharedDataFile =
          PathUtils.get(cleanPath(settings.get("path.shared_data")));
    } else {
      sharedDataFile = null;
    }
    String[] repoPaths = settings.getAsArray("path.repo");
    if (repoPaths.length > 0) {
      repoFiles = new Path[repoPaths.length];
      for (int i = 0; i < repoPaths.length; i++) {
        repoFiles[i] = PathUtils.get(repoPaths[i]);
      }
    } else {
      repoFiles = new Path[0];
    }
    if (settings.get("path.logs") != null) {
      logsFile = PathUtils.get(cleanPath(settings.get("path.logs")));
    } else {
      logsFile = homeFile.resolve("logs");
    }
    if (settings.get("pidfile") != null) {
      pidFile = PathUtils.get(cleanPath(settings.get("pidfile")));
    } else {
      pidFile = null;
    }
    binFile = homeFile.resolve("bin");
    libFile = homeFile.resolve("lib");
  }
  public Settings settings() { return this.settings; }
  public Path[] dataFiles() { return dataFiles; }
  public Path sharedDataFile() { return sharedDataFile; }
  public Path[] dataWithClusterFiles() { return dataWithClusterFiles; }
  public Path[] repoFiles() { return repoFiles; }
  public Path resolveRepoFile(String location) {
    return PathUtils.get(repoFiles, location);
  }
  public URL resolveRepoURL(URL url) {
    try {
      if ("file".equalsIgnoreCase(url.getProtocol())) {
        if (url.getHost() == null || "".equals(url.getHost())) {
          Path path = PathUtils.get(repoFiles, url.toURI());
          if (path == null) {
            return null;
          }
          return path.toUri().toURL();
        }
        return null;
      } else if ("jar".equals(url.getProtocol())) {
        String file = url.getFile();
        int pos = file.indexOf("!/");
        if (pos < 0) {
          return null;
        }
        String jarTail = file.substring(pos);
        String filePath = file.substring(0, pos);
        URL internalUrl = new URL(filePath);
        URL normalizedUrl = resolveRepoURL(internalUrl);
        if (normalizedUrl == null) {
          return null;
        }
        return new URL("jar", "", normalizedUrl.toExternalForm() + jarTail);
      } else {
        return null;
      }
    } catch (MalformedURLException ex) {
      return null;
    } catch (URISyntaxException ex) {
      return null;
    }
  }
  public Path configFile() { return configFile; }
  public Path scriptsFile() { return scriptsFile; }
  public Path pluginsFile() { return pluginsFile; }
  public Path binFile() { return binFile; }
  public Path libFile() { return libFile; }
  public Path logsFile() { return logsFile; }
  public Path pidFile() { return pidFile; }
  public Path tmpFile() { return tmpFile; }
  public FileStore getFileStore(Path path) throws IOException {
    return ESFileStore.getMatchingFileStore(path, fileStores);
  }
  public URL resolveConfig(String path) throws FailedToResolveConfigException {
    Path f = configFile.resolve(path);
    if (Files.exists(f)) {
      try {
        return f.toUri().toURL();
      } catch (MalformedURLException e) {
        throw new FailedToResolveConfigException(
            "Failed to resolve path [" + f + "]", e);
      }
    }
    URL resource = settings.getClassLoader().getResource(path);
    if (resource != null) {
      return resource;
    }
    if (!path.startsWith("config/")) {
      resource = settings.getClassLoader().getResource("config/" + path);
      if (resource != null) {
        return resource;
      }
    }
    throw new FailedToResolveConfigException("Failed to resolve config path [" +
                                             path + "], tried config path [" +
                                             f + "] and classpath");
  }
}